{% extends "layout.html" %}
{% from 'macros.html' import render_form, render_page_title, render_transaction_alert %}

{% block title %}
    {{ configs.page_title | default_title }}
{% endblock %}

{% block css %}
{% endblock %}

{% block content %}
    {{ render_page_title(configs.module, configs.url_index, configs.action) }}

    {% if message %}
        {{ render_transaction_alert(message.type,message.message) }}
    {% endif %}


    <!-- BEGIN BASIC FORM ELEMENTS-->
    <div class="row">
        <div class="col-md-12">
            <div class="grid simple">
                <div class="grid-title no-border">
                    <h4>&nbsp;</h4>
                    <div class="tools">
                        <a href="javascript:;" class="collapse"></a>
                        <a href="#grid-config" data-toggle="modal" class="config"></a>
                        <a href="javascript:;" class="reload"></a>
                        <a href="javascript:;" class="remove"></a>
                    </div>
                </div>
                <div class="grid-body no-border">
                    <br>
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-xs-6">
                        </div>
                        <div id="{{ configs.from_id }}" class="col-md-6 col-sm-6 col-xs-6">
                            <p>
                                اعتبار شما {{ my_credit | format_currency | enToPersianNumb }} ریال است.
                            </p>
                            <p>
                                مبلغ درخواستی خود را وارد نمایید. این مبلغ باید حداقل ۵۰۰ هزار ریال باشد.
                            </p>
                            <p>
                                &nbsp;
                            </p>
                            {{ render_form(form, action_url=url_for(configs.url, id=configs.id), action_text='ویرایش درخواست',btn_class='btn btn-primary btn-cons') }}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END BASIC FORM ELEMENTS-->
{% endblock %}

{% block js %}
    <script src="{{ url_for('static', filename='assets/js/form_validations.js') }}" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var form_status = false;

            $("#publisher-credit-request-form form").submit(function(event){
                if ($("#amount").val()=='' || form_status==false){
                    var icon = $("#amount").parent('.input-with-icon').children('i');
                    var parent = $("#amount").parent('.input-with-icon');
                    icon.removeClass('fa fa-check').addClass('fa fa-exclamation');
                    parent.removeClass('success-control').addClass('error-control');
                    event.preventDefault();
                }
            });

            validateNumber = function (element, value) {
                if (!/^\d+$/.test(value) || (value < 500000) || (value > {{ my_credit }})) {
                    var icon = $(element).parent('.input-with-icon').children('i');
                    var parent = $(element).parent('.input-with-icon');
                    icon.removeClass('fa fa-check').addClass('fa fa-exclamation');
                    parent.removeClass('success-control').addClass('error-control');
                    form_status = false;
                } else {
                    var icon = $(element).parent('.input-with-icon').children('i');
                    var parent = $(element).parent('.input-with-icon');
                    icon.removeClass("fa fa-exclamation").addClass('fa fa-check');
                    parent.removeClass('error-control').addClass('success-control');
                    form_status = true;
                }
            };

            function commaSeparateNumber(val) {
                while (/(\d+)(\d{3})/.test(val.toString())) {
                    val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
                }
                return val;
            }

            $("#amount").keyup(function () {
                var noCommas = $(this).val().replace(/,/g, '');
                validateNumber(this, noCommas);
                $(this).val(commaSeparateNumber(noCommas));
            });

            if ($("#amount").val() != '') {
                validateNumber("#amount", $("#amount").val());
                $("#amount").val(commaSeparateNumber($("#amount").val()));
            }

            if ({{ my_credit }} < 500000){
                $("#amount").prop("disabled", true);
                form_status = false;
            }

        });
    </script>
{% endblock %}