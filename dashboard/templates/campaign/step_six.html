{% extends "layout.html" %}
{% from 'macros.html' import render_page_title, render_campaign_steps, render_form, render_campaign_steps_search_engine %}

{% block title %}
    {{ configs.page_title | default_title }}
{% endblock %}

{% block css %}
    <link href="{{ url_for('static', filename='assets/plugins/bootstrap-select2/select2.css') }}" rel="stylesheet"
          type="text/css" media="screen"/>
{% endblock %}

{% block content %}
    {{ render_page_title(configs.module, configs.url_index, configs.action) }}

    {% if configs.campaign_type_name == 'banner' or configs.campaign_type_name == 'mobile'  or configs.campaign_type_name == 'native' or configs.campaign_type_name == 'iframe' %}
        {{ render_campaign_steps(configs.campaign_id,'active','active','active','active','active','current','') }}
    {% elif configs.campaign_type_name == 'search_engine' %}
        {{ render_campaign_steps_search_engine(configs.campaign_id,'active','active','active','active','active','current','') }}
    {% endif %}

    <!-- BEGIN BASIC FORM ELEMENTS-->
    <div class="row">
        <div class="col-md-4 pull-right">
            <div class="targeting-click-price">
                <p>
                    قیمت هر کلیک (ریال)
                </p>
                <p class="targeting-click-price-content">
                    1500
                </p>
                <div dir="ltr" id="container" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
            </div>
        </div>
        <div class="col-md-8 pull-left">
            <div class="grid simple">
                <div class="grid-body no-border">
                    <br>

                    <div class="col-md-12 targeting-form">

                        {{ render_form(form, action_url=url_for(configs.url, campaign_id=configs.campaign_id, campaign_step=configs.campaign_step), action_text='ثبت و ادامه' ,btn_class='btn btn-primary btn-cons') }}


                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- END BASIC FORM ELEMENTS-->
{% endblock %}

{% block js %}
    <script src="{{ url_for('static', filename='assets/plugins/bootstrap-select2/select2.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='assets/plugins/bootstrap-select2/select2_locale_fa.js') }}"
            type="text/javascript"></script>

    <script src="http://code.highcharts.com/highcharts.js"></script>


    <script type="text/javascript">
        $(document).ready(function () {

            $("#keywords").removeClass('form-control');
            $("#keywords").val([{% for key, value in form.keywords.choices %} "{{ value }}", {% endfor %}]).select2();

            var html = '<div class="col-md-4 pull-left keyword-add-frame"><div class="input-group"><input type="text" placeholder="کلمه کلیدی را وارد نمایید" class="form-control add-input">';
            html += '<span class="input-group-addon primary"><span class="arrow"></span><i class="fa fa-plus"></i></span></div></div>';
            html += '<button type="button" id="suggest-keywords-btn" class="btn btn-info btn-cons">توسعه کلمات کلیدی</button>';
            $(".keywords").prepend(html);


            $(document).on('click', ".keyword-add-frame .input-group-addon", function () {
                if($('.keyword-add-frame .add-input').val()==''){
                    alert("لطفا کلمه کلیدی را وارد نمایید.");
                    return;
                }
                $('#keywords').append('<option selected value="' + $.trim($('.keyword-add-frame .add-input').val()) + '">' + $.trim($('.keyword-add-frame .add-input').val()) + '</option>');
                $("#keywords").val($("#keywords").val()).select2();
                $('.keyword-add-frame .add-input').val('');
                getClickPrice();
            });


             $(document).on('click', "#suggest-keywords-btn", function () {
                 var keywords = {"keywords":$("#keywords").val()};
                 if ($("#keywords").val() == null){
                     alert("لطفا حداقل یک کلمه کلیدی را وارد نمایید.");
                     return;
                 }
                 $.ajax({
                    url: '/dashboard/advertiser/query/expansion',
                    data: JSON.stringify(keywords),
                    contentType: 'application/json;charset=UTF-8',
                    type: 'POST',
                    success: function (data) {
                        for (var index in data) {
                            $('#keywords').append('<option selected value="' + $.trim(data[index]) + '">' + $.trim(data[index]) + '</option>');
                        }
                        $("#keywords").val($("#keywords").val()).select2();
                        getClickPrice();
                    }
                });
             });

            $(".targeting-form .geography input[type=radio][name=geography]").change(function () {
                if (this.value == 'special') {
                    $(".targeting-form .states").slideDown();
                }
                else {
                    $(".targeting-form .states").slideUp();
                }
            });

            $(".targeting-form .subject input[type=radio][name=subject]").change(function () {
                if (this.value == 'special') {
                    $(".targeting-form .subjects").slideDown();
                }
                else {
                    $(".targeting-form .subjects").slideUp();
                }
            });

            $(".targeting-form .operating_system input[type=radio][name=operating_system]").change(function () {
                if (this.value == 'special') {
                    $(".targeting-form .operating_systems").slideDown();
                }
                else {
                    $(".targeting-form .operating_systems").slideUp();
                }
            });

            $(".targeting-form .playtime input[type=radio][name=playtime]").change(function () {
                if (this.value == 'special') {
                    $(".targeting-form .playtime_special").slideDown();
                }
                else {
                    $(".targeting-form .playtime_special").slideUp();
                }
            });

            $(".targeting-form .keyword input[type=radio][name=keyword]").change(function () {
                if (this.value == 'special') {
                    $(".targeting-form .keywords").slideDown();
                }
                else {
                    $(".targeting-form .keywords").slideUp();
                }
            });

            $(".targeting-form .retargeting input[type=radio][name=retargeting]").change(function () {
                if (this.value == 'yes') {
                    $(".targeting-form .retargeting_code").slideDown();
                }
                else {
                    $(".targeting-form .retargeting_code").slideUp();
                }
            });

            $("#retargeting_code").focus(function () {
                var $this = $(this);
                $this.select();
                $this.mouseup(function () {
                    $this.unbind("mouseup");
                    return false;
                });
            });

            if ($(".targeting-form .keyword input[type=radio][name=keyword]:checked").val() == "special") {
                $(".targeting-form .keywords").addClass("keywords-open");
            }

            {% if not form.keyword %}
                $(".targeting-form .keywords").addClass("keywords-open");
            {% endif %}

            if ($(".targeting-form .retargeting input[type=radio][name=retargeting]:checked").val() == "yes") {
                $(".targeting-form .retargeting_code").addClass("retargeting_code-open");
            }

        })
    </script>
    <script>
        $(document).ready(function () {

            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'container',
                    type: 'pie',
                    backgroundColor: null
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: ''
                },
                yAxis: {
                    title: {
                        text: 'Total percent market share'
                    }
                },
                legend: {
                    rtl: true,
                    itemStyle: {
                        fontSize: '13px',
                        font: '13px iraniansans',
                        color: '#fff'
                    }
                },
                plotOptions: {
                    pie: {
                        shadow: false,
                        borderWidth: 0
                    }
                },
                tooltip: {
                    formatter: function () {
                        return '<b>' + this.point.name + '</b>: ' + this.y + ' ریال ';
                    }
                },
                series: [{
                    name: 'Browsers',
                    data: [],
                    size: '60%',
                    innerSize: '60%',
                    showInLegend: true,
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return Math.round(this.percentage * 100) / 100 + ' %';
                        },
                        color: 'white',
                        borderWidth: '1',
                        align: 'center',
                        x: 0,
                        y: 0,
                        rotation: 0,
                    }
                }]
            });


            getRadioValue = function (elementName) {
                var element = document.getElementsByName(elementName);
                var bt_count = element.length; // can't use element.length in the loop, as it would decrement
                for (var i = 0; i < bt_count; i++)
                    if (element[i].checked == true)
                        return element[i].value;
            };

            getCheckboxValue = function (elementName) {
                var element = document.getElementsByName(elementName);
                var bt_count = element.length; // can't use element.length in the loop, as it would decrement
                var items = [];
                for (var i = 0; i < bt_count; i++)
                    if (element[i].checked == true)
                        items.push(element[i].value);
                return items;
            };


            getClickPrice = function () {
                chart.series[0].setData([]);

                var geography = getRadioValue('geography');
                var subject = getRadioValue('subject');
                var operating_system = getRadioValue('operating_system');
                var playtime = getRadioValue('playtime');
                var keyword = getRadioValue('keyword');

                var basePrice = {{ base_price }};
                chart.series[0].addPoint(["قیمت پایه", {{ base_price }}]);

                if (getRadioValue('site_grade') == 'class_a') {
                    basePrice += 3000;
                    chart.series[0].addPoint(["سایت های پخش کننده", 3000]);
                }

                if (getRadioValue('site_grade') == 'class_b') {
                    basePrice += 1500;
                    chart.series[0].addPoint(["سایت های پخش کننده", 1500]);
                }

                var price = basePrice;

                if (geography == 'iran') {
                    price += 400;
                    chart.series[0].addPoint(["جغرافیایی", 400]);
                }
                else if (geography == 'not_iran') {
                    price += 400;
                    chart.series[0].addPoint(["جغرافیایی", 400]);
                }
                else if (geography == 'special' && getCheckboxValue("states") != '') {
                    var items = getCheckboxValue("states");
                    if (items.length == 5) {
                        $(".states input:checkbox").each(function () {
                            if (!$(this).prop("checked")) {
                                $(this).attr("disabled", true);
                            }
                        });
                    } else {
                        $(".states input:checkbox").each(function () {
                            $(this).attr("disabled", false);
                        });
                    }
                    price += 400;
                    chart.series[0].addPoint(["جغرافیایی", 400]);
                }

                if ('{{ configs.campaign_type_name }}' == 'mobile') {
                    $('#operating_system_all').attr("disabled", true);
                }

                if (operating_system == 'special' && getCheckboxValue("operating_systems") != '') {
                    var items = getCheckboxValue("operating_systems");

                    if (items.length == $('.operating_systems input:checkbox').length && '{{ configs.campaign_type_name }}' != 'mobile') {
                        $("#operating_system_all").prop("checked", true);
                        $(".targeting-form .operating_systems").slideUp();
                        $(".operating_systems input:checkbox").each(function () {
                            $(this).prop("checked", false);
                        });
                        getClickPrice();
                        return;
                    }

                    price += 400;
                    chart.series[0].addPoint(["سیستم عامل", 400]);
                }

                if (subject == 'special' && getCheckboxValue("subjects") != '') {
                    var items = getCheckboxValue("subjects");
                    if (items.length == 2) {
                        $(".subjects input:checkbox").each(function () {
                            if (!$(this).prop("checked")) {
                                $(this).attr("disabled", true);
                            }
                        });
                    } else {
                        $(".subjects input:checkbox").each(function () {
                            $(this).attr("disabled", false);
                        });
                    }
                    price += 400;
                    chart.series[0].addPoint(["موضوعی", 400]);
                }

                if (playtime == 'special' && getCheckboxValue("playtime_special") != '') {
                    var items = getCheckboxValue("playtime_special");
                    if (items.length == 2) {
                        $(".playtime_special input:checkbox").each(function () {
                            if (!$(this).prop("checked")) {
                                $(this).attr("disabled", true);
                            }
                        });
                    } else {
                        $(".playtime_special input:checkbox").each(function () {
                            $(this).attr("disabled", false);
                        });
                    }
                    var totalPricePlaytime = 0;
                    if (items.indexOf('not_24_08') != -1) {
                        price += 400;
                        totalPricePlaytime += 400;
                    }
                    if (items.indexOf('not_08_16') != -1) {
                        price += 100;
                        totalPricePlaytime += 100;
                    }
                    if (items.indexOf('not_16_24') != -1) {
                        price += 300;
                        totalPricePlaytime += 300;
                    }
                    chart.series[0].addPoint(["زمان پخش", totalPricePlaytime]);
                }

                if (keyword == 'special' && $("#keywords").val() != null) {
                    price += basePrice * (10 / 100);
                    chart.series[0].addPoint(["کلمات کلیدی", basePrice * (10 / 100)]);
                }


                var oldPrice = $(".targeting-click-price-content").text();
                $(".targeting-click-price-content").prop('Counter', oldPrice).animate({
                    Counter: price
                }, {
                    duration: 1300,
                    easing: 'swing',
                    step: function (now) {
                        $(this).text(Math.ceil(now));
                    }
                });

                $(".targeting-form #price").val(price);


            };

            $(".targeting-form input[type=radio]").change(function () {
                getClickPrice();
            });

            $(".targeting-form #keywords").change(function () {
                getClickPrice();
            });

            $(document).on('click', ".targeting-form input[type=checkbox]", function () {
                getClickPrice();
            });
            getClickPrice();


            var fixmeTop = $('.targeting-click-price').offset().top;
            $(window).scroll(function () {
                var currentScroll = $(window).scrollTop() + 90;
                if (currentScroll >= fixmeTop) {
                    $('.targeting-click-price').css({
                        position: 'fixed',
                        top: '90px'
                    });
                } else {
                    $('.targeting-click-price').css({
                        position: 'static'
                    });
                }
            });


        });

    </script>

    <script type="text/javascript">
        var csrf_token = "{{ csrf_token() }}";
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            }
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function () {

            var landing_page_url = '{{ landing_page_url }}';
            if ((landing_page_url != 'None') && (landing_page_url != '') && ($("#keywords :selected").length == 0)) {
                $.ajax({
                    url: '/dashboard/advertiser/campaign/keyword/suggestion',
                    type: "post",
                    data: {'landing_page_url': landing_page_url},
                    success: function (result) {
                        for (i = 0; i < result['body'].length; i++) {
                            $('#keywords').append("<option selected value=\"" + result['body'][i] + "\">" + result['body'][i] + "</option>");
                        }
                        $("#keywords").select2();
                    }
                });
            }

        })
    </script>

{% endblock %}